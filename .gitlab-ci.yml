image: node:latest

stages:
  - build
  - test
  - release

variables:
  GIT_DEPTH: "0"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

create_wheel:
  stage: build
  script:
    - pip wheel tree-sitter-language-pack==0.2.0 --wheel-dir ./wheels
  artifacts:
    paths:
      - ./wheels/*.whl
    expire_in: 2 week
  cache:
    key: 
      files:
        - requirements.txt  # Asume que tienes un archivo de requerimientos
    paths:
      - ./wheels
      - $PIP_CACHE_DIR
    policy: pull-push

test:
  image: python:3.12
  stage: test
  cache:
    key: 
      files:
        - requirements.txt
    paths:
      - ./wheels
      - $PIP_CACHE_DIR
    policy: pull
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install --no-index --find-links=./wheels tree-sitter-language-pack==0.2.0
    - pip install -r requirements.txt
  script:
    - pytest

release:
  image: node:latest
  variables:
    PYPI_TOKEN: ${CI_JOB_TOKEN}
    PYPI_USERNAME: gitlab-ci-token
    PYPI_REPO_URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi
    GITLAB_TOKEN: $GITLAB_TOKEN
  stage: release
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates
    - npm install -g semantic-release @semantic-release/gitlab @semantic-release/git @semantic-release/changelog
  script:
    - semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "develop"
      changes:
        - pluscoder/**/*
        - requirements.txt